
function formatJPY(n){return new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0}).format(n)}
function pct(n){return new Intl.NumberFormat('ja-JP',{maximumFractionDigits:2}).format(n)}
function $(sel,root=document){return root.querySelector(sel)}
function $$(sel,root=document){return Array.from(root.querySelectorAll(sel))}
function getStoreFilters(){const u=new URL(location.href);const ex=u.searchParams.getAll('exclude');const all=window.PRICE_DATA.stores;return {all,excluded:ex,selected:all.filter(s=>!ex.includes(s))}}
function setStoreFilters(ex){const u=new URL(location.href);u.searchParams.delete('exclude');(ex||[]).forEach(x=>u.searchParams.append('exclude',x));history.replaceState(null,'',u.toString())}
function buildItems(){const ms=window.PRICE_DATA.msrp;const {selected}=getStoreFilters();const items=[];for(const v of window.PRICE_DATA.variants){const colors=v.colors||{"全色":{}};for(const [color,map] of Object.entries(colors)){const per=[];for(const st of selected){let price=map[st];if(price==null){const p=(v.prices||[]).find(x=>x.store===st&&x.price_jpy!=null);price=p?p.price_jpy:null}if(price!=null){const link=(v.prices||[]).find(x=>x.store===st)?.link||'#';per.push({store:st,price_jpy:price,link})}}if(!per.length)continue;per.sort((a,b)=>b.price_jpy-a.price_jpy);const top=per[0];const msrp=ms[v.sku];items.push({sku:v.sku,title:v.title,color,msrp,top,perStore:per})}}return items.sort((a,b)=> (b.top.price_jpy/b.msrp)-(a.top.price_jpy/a.msrp)|| (b.top.price_jpy-a.top.price_jpy))}
function renderStoreFilters(el){const {all,excluded}=getStoreFilters();el.innerHTML='';all.forEach(s=>{const id='store-'+s;const lb=document.createElement('label');lb.style.marginRight='12px';lb.innerHTML=`<input type="checkbox" id="${id}" value="${s}" ${excluded.includes(s)?'':'checked'}> ${s}`;el.appendChild(lb)});const btn=document.createElement('button');btn.className='btn';btn.textContent='適用';btn.onclick=()=>{const ex=[];el.querySelectorAll('input[type="checkbox"]').forEach(c=>{if(!c.checked)ex.push(c.value)});setStoreFilters(ex);if(typeof window.onFiltersApplied==='function')window.onFiltersApplied()};el.appendChild(btn)}
window.SITE={buildItems,renderStoreFilters,getStoreFilters};
